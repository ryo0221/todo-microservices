version: "3.9"

# ──────────────────────────────────────────────────────────────────────────────
# Todo Microservices – Local Dev Stack
#   - gateway  : FastAPI-based reverse proxy (path routing /auth/*, /todos/*)
#   - auth     : Auth service (register/login, issues JWT)
#   - todo     : Todo CRUD service (validates JWT)
#   - postgres : Single Postgres instance hosting multiple DBs (auth_db, todo_db)
#
# Start:   docker compose -f infra/docker/docker-compose.yml up --build
# Cleanup: docker compose -f infra/docker/docker-compose.yml down -v
# ──────────────────────────────────────────────────────────────────────────────

services:
  gateway:
    build:
      context: ../../gateway
      dockerfile: Dockerfile
    container_name: ms-gateway
    ports:
      - "8080:8000"
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    volumes:
      - ../../gateway:/app
    env_file:
      - ../../gateway/.env
    environment:
      PYTHONPATH: /app
      # Downstream service base URLs (service discovery via Docker DNS)
      AUTH_SERVICE_URL: http://auth:8000
      TODO_SERVICE_URL: http://todo:8000
      LOG_LEVEL: INFO
    depends_on:
      auth:
        condition: service_healthy
      todo:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8080/health"]
      interval: 10s
      timeout: 3s
      retries: 10
    networks:
      - internal

  auth:
    build:
      context: ../../services/auth
      dockerfile: Dockerfile
    container_name: ms-auth
    volumes:
      - ../../services/auth:/app
    env_file:
      - ../../services/auth/.env
    environment:
      PYTHONPATH: /app
      LOG_LEVEL: INFO
    expose:
      - "8000"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health"]
      interval: 10s
      timeout: 3s
      retries: 10
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    networks:
      - internal

  todo:
    build:
      context: ../../services/todo
      dockerfile: Dockerfile
    container_name: ms-todo
    volumes:
      - ../../services/todo:/app
    env_file:
      - ../../services/todo/.env
    environment:
      LOG_LEVEL: INFO
      PYTHONPATH: /app
    expose:
      - "8000"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health"]
      interval: 10s
      timeout: 3s
      retries: 10
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    networks:
      - internal

  postgres:
    image: postgres:16-alpine
    container_name: ms-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      # The default POSTGRES_DB is created automatically ("postgres").
      # We'll create additional DBs/users via init SQL below.
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ../../infra/docker/init/01-init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - internal

  # Optional: Jaeger for tracing (uncomment when OpenTelemetry is wired)
  # jaeger:
  #   image: jaegertracing/all-in-one:1.57
  #   container_name: ms-jaeger
  #   ports:
  #     - "16686:16686"   # UI
  #     - "4317:4317"     # OTLP gRPC
  #     - "4318:4318"     # OTLP HTTP
  #   networks:
  #     - msnet

volumes:
  pgdata:

networks:
  internal:
    driver: bridge
